// ======================================================================
// –ù–ê–ó–í–ê–ù–ò–ï: 077_ESP8266_Node_ESP-NOW_Final.ino
// –í–ï–†–°–ò–Ø: 1.0 (–ü–µ—Ä–µ–¥–µ–ª–∞–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Å ESP-NOW)
// –£–°–¢–†–û–ô–°–¢–í–û: ESP8266 (Node #1) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ESP-NOW
// –§–£–ù–ö–¶–ò–Ø: –î–∞—Ç—á–∏–∫–∏ + —Ü–µ–ø–∏ ‚Üí –¥–∞–Ω–Ω—ã–µ –ø–æ HTTP, –∫–æ–º–∞–Ω–¥—ã –ø–æ ESP-NOW
// ======================================================================

#include <Wire.h>
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClient.h>
#include <ArduinoJson.h>
#include <espnow.h>

// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –£–ó–õ–ê #1 ==========
#define NODE_ID 1                    // –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID
#define SDA_PIN D2
#define SCL_PIN D1
#define AHT_ADDR 0x38
#define BMP_ADDR 0x76

// –¶–µ–ø–∏ (–≤–∞—à–∏ GPIO)
#define CHAIN_1_PIN D5
#define CHAIN_2_PIN D6
#define CHAIN_3_PIN D7
#define STATUS_LED_PIN LED_BUILTIN   // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π LED

// –†–µ–ª–µ/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–Ω–∞–∑–Ω–∞—á—å—Ç–µ –Ω—É–∂–Ω—ã–µ –ø–∏–Ω—ã)
#define RELAY_1_PIN D0
#define RELAY_2_PIN D3
#define LED_PIN D4                   // –í–Ω–µ—à–Ω–∏–π LED

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∏
const char* HUB_SSID = "ESP32_Hub_Network";
const char* HUB_PASSWORD = "node12345678";
const char* HUB_IP = "192.168.4.1";

// MAC-–∞–¥—Ä–µ—Å —Ö–∞–±–∞ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô –ú–ê–ö –•–ê–ë–ê!)
uint8_t hubMacAddress[] = {0x9C, 0x9C, 0x1F, 0xC7, 0x2D, 0x94};

// ========== –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• ESP-NOW ==========
typedef struct esp_now_message {
    char command[16];
    uint8_t sender_id;
    uint8_t target_id;
} esp_now_message;

esp_now_message incomingMessage;
esp_now_message outgoingMessage;

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
bool ahtFound = false, bmpFound = false;
bool hubConnected = false;
bool alarmTriggered = false;
bool espNowInitialized = false;

// –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
float tempAHT = NAN, humAHT = NAN, tempBMP = NAN, pressBMP = NAN;

// –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ü–µ–ø–µ–π –∏ —Ä–µ–ª–µ
int chain1State = 0, chain2State = 0, chain3State = 0;
int lastChain1 = 0, lastChain2 = 0, lastChain3 = 0;
bool ledState = false;
bool relay1State = false;
bool relay2State = false;

// –¢–∞–π–º–µ—Ä—ã
unsigned long lastSensorRead = 0;
unsigned long lastHubSend = 0;
unsigned long lastAlarmSend = 0;
unsigned long lastSerialPrint = 0;
unsigned long lastEspNowCheck = 0;

const unsigned long SENSOR_READ_INTERVAL = 2000;
const unsigned long HUB_SEND_INTERVAL = 10000;     // HTTP –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
const unsigned long ALARM_COOLDOWN = 5000;
const unsigned long RECONNECT_INTERVAL = 30000;
const unsigned long SERIAL_PRINT_INTERVAL = 5000;
const unsigned long ESPNOW_CHECK_INTERVAL = 60000;

WiFiClient wifiClient;
HTTPClient http;
String lastReceivedCommand = "";

// ========== –ü–†–û–¢–û–¢–ò–ü–´ –§–£–ù–ö–¶–ò–ô ==========
void initSensors();
void setupWiFi();
void setupESP_NOW();
void processCommand(String command);
void sendAckToHub(const char* ackCommand);
void readSensors();
void readChains();
void checkAlarmConditions(unsigned long now);
void updateStatusLED();
void sendToHub(bool isEmergency);
void printToSerial();

// –ö–æ–ª–±—ç–∫–∏ ESP-NOW
void onEspNowDataRecv(uint8_t *mac, uint8_t *data, uint8_t len);
void onEspNowDataSend(uint8_t *mac, uint8_t status);

// ======================================================================
// SETUP
// ======================================================================
void setup() {
    Serial.begin(115200);
    delay(2000);
    
    Serial.println("\n=== –£–ó–ï–õ ESP8266 #1 (ESP-NOW –≤–µ—Ä—Å–∏—è) ===");
    Serial.println("ID —É–∑–ª–∞: " + String(NODE_ID));
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
    pinMode(STATUS_LED_PIN, OUTPUT);
    digitalWrite(STATUS_LED_PIN, HIGH); // LED –≤—ã–∫–ª—é—á–µ–Ω (–∞–∫—Ç–∏–≤–Ω—ã–π LOW –Ω–∞ ESP8266)
    
    pinMode(LED_PIN, OUTPUT);
    digitalWrite(LED_PIN, HIGH);
    
    pinMode(RELAY_1_PIN, OUTPUT);
    digitalWrite(RELAY_1_PIN, LOW);
    
    pinMode(RELAY_2_PIN, OUTPUT);
    digitalWrite(RELAY_2_PIN, LOW);
    
    pinMode(CHAIN_1_PIN, INPUT_PULLUP);
    pinMode(CHAIN_2_PIN, INPUT_PULLUP);
    pinMode(CHAIN_3_PIN, INPUT_PULLUP);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è I2C –∏ –¥–∞—Ç—á–∏–∫–æ–≤
    Wire.begin(SDA_PIN, SCL_PIN);
    delay(100);
    initSensors();
    
    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Wi-Fi
    setupWiFi();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ESP-NOW
    setupESP_NOW();
    
    Serial.println("\n‚úÖ –£–∑–µ–ª #1 –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");
    Serial.println("–†–µ–∂–∏–º: –î–∞—Ç—á–∏–∫–∏ ‚Üí HTTP, –ö–æ–º–∞–Ω–¥—ã ‚Üê ESP-NOW");
}

// ======================================================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢–ß–ò–ö–û–í
// ======================================================================
void initSensors() {
    Serial.println("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–æ–≤...");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ AHT20
    Wire.beginTransmission(AHT_ADDR);
    ahtFound = (Wire.endTransmission() == 0);
    Serial.print("AHT20: ");
    Serial.println(ahtFound ? "OK (0x38)" : "–ù–ï–¢");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ BMP280 (—Ç—Ä–µ–±—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É, —É–ø—Ä–æ—â–∞–µ–º)
    Wire.beginTransmission(BMP_ADDR);
    bmpFound = (Wire.endTransmission() == 0);
    Serial.print("BMP280: ");
    Serial.println(bmpFound ? "OK (0x76)" : "–ù–ï–¢");
    
    // –î–ª—è BMP280 –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Adafruit_BMP280
    // –ï—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ—Ç - –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ BMP280
}

// ======================================================================
// –ù–ê–°–¢–†–û–ô–ö–ê WI-FI
// ======================================================================
void setupWiFi() {
    Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö–∞–±—É '");
    Serial.print(HUB_SSID);
    Serial.print("'... ");
    
    WiFi.setOutputPower(10.5); // –£–º–µ–Ω—å—à–∞–µ–º –º–æ—â–Ω–æ—Å—Ç—å –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä–µ–≤–∞
    WiFi.begin(HUB_SSID, HUB_PASSWORD);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 25) {
        digitalWrite(STATUS_LED_PIN, (attempts % 2) ? HIGH : LOW);
        delay(250);
        Serial.print(".");
        attempts++;
    }
    
    hubConnected = (WiFi.status() == WL_CONNECTED);
    
    if (hubConnected) {
        Serial.println(" –£–°–ü–ï–•");
        Serial.print("IP —É–∑–ª–∞: ");
        Serial.println(WiFi.localIP());
        Serial.print("MAC —É–∑–ª–∞: ");
        Serial.println(WiFi.macAddress());
        Serial.print("RSSI: ");
        Serial.print(WiFi.RSSI());
        Serial.println(" dBm");
        digitalWrite(STATUS_LED_PIN, LOW);
    } else {
        Serial.println(" –ù–ï –£–î–ê–õ–û–°–¨");
        digitalWrite(STATUS_LED_PIN, HIGH);
        Serial.println("–†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ ESP-NOW");
    }
}

// ======================================================================
// –ù–ê–°–¢–†–û–ô–ö–ê ESP-NOW
// ======================================================================
void setupESP_NOW() {
    Serial.print("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ESP-NOW... ");
    
    if (esp_now_init() != 0) {
        Serial.println("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!");
        espNowInitialized = false;
        return;
    }
    
    esp_now_set_self_role(ESP_NOW_ROLE_COMBO);
    esp_now_register_recv_cb(onEspNowDataRecv);
    esp_now_register_send_cb(onEspNowDataSend);
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–∞–±–∞ –∫–∞–∫ –ø–∏—Ä–∞
    esp_now_add_peer(hubMacAddress, ESP_NOW_ROLE_COMBO, 1, NULL, 0);
    
    Serial.println("‚úÖ –£—Å–ø–µ—à–Ω–æ");
    Serial.print("–•–∞–± MAC: ");
    for(int i=0; i<6; i++) {
        Serial.print(hubMacAddress[i], HEX);
        if(i<5) Serial.print(":");
    }
    Serial.println();
    espNowInitialized = true;
}

// ======================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –û–¢ –•–ê–ë–ê
// ======================================================================
void processCommand(String command) {
    Serial.print("üîß –ö–æ–º–∞–Ω–¥–∞ –æ—Ç —Ö–∞–±–∞: ");
    Serial.println(command);
    
    lastReceivedCommand = command;
    
    if (command == "LED_ON") {
        digitalWrite(LED_PIN, LOW); // –ê–∫—Ç–∏–≤–Ω—ã–π LOW –Ω–∞ ESP8266
        ledState = true;
        Serial.println("üí° LED –í–ö–õ–Æ–ß–Å–ù");
        sendAckToHub("ACK_ON");
        
    } else if (command == "LED_OFF") {
        digitalWrite(LED_PIN, HIGH);
        ledState = false;
        Serial.println("üí° LED –í–´–ö–õ–Æ–ß–ï–ù");
        sendAckToHub("ACK_OFF");
        
    } else if (command == "RELAY_1_ON") {
        digitalWrite(RELAY_1_PIN, HIGH);
        relay1State = true;
        Serial.println("üîå –†–ï–õ–ï 1 –í–ö–õ–Æ–ß–ï–ù–û");
        sendAckToHub("ACK_RELAY1_ON");
        
    } else if (command == "RELAY_1_OFF") {
        digitalWrite(RELAY_1_PIN, LOW);
        relay1State = false;
        Serial.println("üîå –†–ï–õ–ï 1 –í–´–ö–õ–Æ–ß–ï–ù–û");
        sendAckToHub("ACK_RELAY1_OFF");
        
    } else if (command == "RELAY_2_ON") {
        digitalWrite(RELAY_2_PIN, HIGH);
        relay2State = true;
        Serial.println("üîå –†–ï–õ–ï 2 –í–ö–õ–Æ–ß–ï–ù–û");
        sendAckToHub("ACK_RELAY2_ON");
        
    } else if (command == "RELAY_2_OFF") {
        digitalWrite(RELAY_2_PIN, LOW);
        relay2State = false;
        Serial.println("üîå –†–ï–õ–ï 2 –í–´–ö–õ–Æ–ß–ï–ù–û");
        sendAckToHub("ACK_RELAY2_OFF");
        
    } else if (command == "GET_STATUS") {
        sendAckToHub("STATUS_OK");
        
    } else {
        Serial.print("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: ");
        Serial.println(command);
    }
}

// ======================================================================
// –û–¢–ü–†–ê–í–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –•–ê–ë–£
// ======================================================================
void sendAckToHub(const char* ackCommand) {
    if (!espNowInitialized) {
        Serial.println("‚ö†Ô∏è ESP-NOW –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        return;
    }
    
    strncpy(outgoingMessage.command, ackCommand, sizeof(outgoingMessage.command)-1);
    outgoingMessage.sender_id = NODE_ID;
    outgoingMessage.target_id = 0;
    
    uint8_t result = esp_now_send(hubMacAddress, (uint8_t *) &outgoingMessage, sizeof(outgoingMessage));
    
    Serial.print("üì§ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ '");
    Serial.print(ackCommand);
    Serial.print("': ");
    Serial.println(result == 0 ? "OK" : "ERROR");
}

// ======================================================================
// –ö–û–õ–ë–≠–ö–ò ESP-NOW
// ======================================================================
void onEspNowDataRecv(uint8_t *mac, uint8_t *data, uint8_t len) {
    memcpy(&incomingMessage, data, min(len, (uint8_t)sizeof(incomingMessage)));
    
    Serial.print("üì• ESP-NOW –æ—Ç ");
    for(int i=0; i<6; i++) {
        Serial.print(mac[i], HEX);
        if(i<5) Serial.print(":");
    }
    Serial.print(": ");
    Serial.print(incomingMessage.command);
    Serial.print(" (—Ü–µ–ª—å: ");
    Serial.print(incomingMessage.target_id);
    Serial.println(")");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ —ç—Ç–æ–º—É —É–∑–ª—É
    if (incomingMessage.target_id == 0 || incomingMessage.target_id == NODE_ID) {
        processCommand(String(incomingMessage.command));
    }
}

void onEspNowDataSend(uint8_t *mac, uint8_t status) {
    if (status != 0) {
        Serial.println("‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ");
    }
}

// ======================================================================
// –ß–¢–ï–ù–ò–ï –î–ê–¢–ß–ò–ö–û–í
// ======================================================================
void readSensors() {
    tempAHT = NAN; humAHT = NAN; tempBMP = NAN; pressBMP = NAN;
    
    // –ß—Ç–µ–Ω–∏–µ AHT20 (–∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ)
    if (ahtFound) {
        Wire.beginTransmission(AHT_ADDR);
        Wire.write(0xAC);
        Wire.write(0x33);
        Wire.write(0x00);
        Wire.endTransmission();
        delay(75);
        
        Wire.requestFrom(AHT_ADDR, 6);
        if (Wire.available() == 6) {
            uint8_t data[6];
            for (int i = 0; i < 6; i++) data[i] = Wire.read();
            
            if ((data[0] & 0x80) == 0) {
                uint32_t rawHum = ((data[1] << 16) | (data[2] << 8) | data[3]) >> 4;
                uint32_t rawTemp = ((data[3] & 0x0F) << 16) | (data[4] << 8) | data[5];
                
                humAHT = (rawHum * 100.0) / 1048576.0;
                tempAHT = (rawTemp * 200.0) / 1048576.0 - 50.0;
            }
        }
    }
    
    // –î–ª—è BMP280 –Ω—É–∂–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ - –∑–¥–µ—Å—å –∑–∞–≥–ª—É—à–∫–∞
    if (bmpFound) {
        // –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Adafruit_BMP280, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
        // tempBMP = bmp.readTemperature();
        // pressBMP = bmp.readPressure() / 133.322;
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
        tempBMP = 22.5 + (random(-50, 51) / 100.0);
        pressBMP = 730.0 + (random(-20, 21) / 10.0);
    }
}

// ======================================================================
// –ß–¢–ï–ù–ò–ï –¶–ï–ü–ï–ô
// ======================================================================
void readChains() {
    lastChain1 = chain1State;
    lastChain2 = chain2State;
    lastChain3 = chain3State;
    
    chain1State = digitalRead(CHAIN_1_PIN);
    chain2State = digitalRead(CHAIN_2_PIN);
    chain3State = digitalRead(CHAIN_3_PIN);
}

// ======================================================================
// –ü–†–û–í–ï–†–ö–ê –ê–í–ê–†–ò–ô–ù–´–• –£–°–õ–û–í–ò–ô
// ======================================================================
void checkAlarmConditions(unsigned long now) {
    if (chain1State != lastChain1 || chain2State != lastChain2 || chain3State != lastChain3) {
        alarmTriggered = true;
        Serial.print("üö® –ò–ó–ú–ï–ù–ï–ù–ò–ï –¶–ï–ü–ï–ô: [");
        Serial.print(chain1State);
        Serial.print(",");
        Serial.print(chain2State);
        Serial.print(",");
        Serial.print(chain3State);
        Serial.println("]");
    }
    
    static float lastTemp = NAN;
    if (!isnan(tempAHT) && !isnan(lastTemp)) {
        if (abs(tempAHT - lastTemp) > 5.0) {
            alarmTriggered = true;
            Serial.print("üö® –°–ö–ê–ß–û–ö –¢–ï–ú–ü–ï–†–ê–¢–£–†–´: ");
            Serial.print(lastTemp, 1);
            Serial.print(" -> ");
            Serial.print(tempAHT, 1);
            Serial.println(" ¬∞C");
        }
    }
    lastTemp = tempAHT;
}

// ======================================================================
// –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ù–ê –•–ê–ë –ü–û HTTP
// ======================================================================
void sendToHub(bool isEmergency) {
    if (!hubConnected) return;
    
    String url = "http://" + String(HUB_IP) + (isEmergency ? "/emergency" : "/data");
    http.begin(wifiClient, url);
    http.addHeader("Content-Type", "application/json");
    
    JsonDocument jsonDoc;
    jsonDoc["nodeId"] = NODE_ID;
    
    if (!isnan(tempAHT)) jsonDoc["tempAHT"] = round(tempAHT * 10) / 10.0;
    if (!isnan(humAHT)) jsonDoc["humAHT"] = round(humAHT * 10) / 10.0;
    if (!isnan(tempBMP)) jsonDoc["tempBMP"] = round(tempBMP * 10) / 10.0;
    if (!isnan(pressBMP)) jsonDoc["pressBMP"] = round(pressBMP * 10) / 10.0;
    
    jsonDoc["chain1"] = chain1State;
    jsonDoc["chain2"] = chain2State;
    jsonDoc["chain3"] = chain3State;
    jsonDoc["rssi"] = WiFi.RSSI();
    jsonDoc["heap"] = ESP.getFreeHeap();
    
    String jsonString;
    serializeJson(jsonDoc, jsonString);
    
    int httpCode = http.POST(jsonString);
    
    if (httpCode > 0) {
        if (httpCode == 200) {
            Serial.print(isEmergency ? "üö® –ê–í–ê–†–ò–ô–ù–´–ï " : "üìä –î–ê–ù–ù–´–ï ");
            Serial.println("–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ö–∞–±");
        }
    } else {
        Serial.print("‚ùå –û—à–∏–±–∫–∞ HTTP: ");
        Serial.println(http.errorToString(httpCode));
        hubConnected = false;
    }
    
    http.end();
}

// ======================================================================
// –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê LED
// ======================================================================
void updateStatusLED() {
    static unsigned long lastLEDUpdate = 0;
    static bool ledBlinkState = HIGH;
    unsigned long now = millis();
    
    if (hubConnected && espNowInitialized) {
        digitalWrite(STATUS_LED_PIN, LOW); // –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –≥–æ—Ä–∏—Ç –ø—Ä–∏ –ø–æ–ª–Ω–æ–π —Å–≤—è–∑–∏
    } else if (hubConnected && !espNowInitialized) {
        // –ú–∏–≥–∞–µ—Ç 1 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ Wi-Fi
        if (now - lastLEDUpdate > 1000) {
            ledBlinkState = !ledBlinkState;
            digitalWrite(STATUS_LED_PIN, ledBlinkState);
            lastLEDUpdate = now;
        }
    } else {
        // –ë—ã—Å—Ç—Ä–æ –º–∏–≥–∞–µ—Ç –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
        if (now - lastLEDUpdate > 250) {
            ledBlinkState = !ledBlinkState;
            digitalWrite(STATUS_LED_PIN, ledBlinkState);
            lastLEDUpdate = now;
        }
    }
}

// ======================================================================
// –í–´–í–û–î –í SERIAL
// ======================================================================
void printToSerial() {
    Serial.print("[–£–∑–µ–ª ");
    Serial.print(NODE_ID);
    Serial.print("] ");
    Serial.print(hubConnected ? "Wi-Fi ‚úì" : "Wi-Fi ‚úó");
    Serial.print(" | ");
    Serial.print(espNowInitialized ? "ESP-NOW ‚úì" : "ESP-NOW ‚úó");
    
    if (ahtFound && !isnan(tempAHT)) {
        Serial.print(" | AHT: ");
        Serial.print(tempAHT, 1);
        Serial.print("¬∞C ");
        Serial.print(humAHT, 1);
        Serial.print("%");
    }
    
    if (bmpFound && !isnan(tempBMP)) {
        Serial.print(" | BMP: ");
        Serial.print(tempBMP, 1);
        Serial.print("¬∞C ");
        Serial.print(pressBMP, 1);
        Serial.print("mmHg");
    }
    
    Serial.print(" | –¶–µ–ø–∏: [");
    Serial.print(chain1State ? "1-–û–ë–†–´–í" : "1-–ù–û–†–ú–ê");
    Serial.print(",");
    Serial.print(chain2State ? "2-–û–ë–†–´–í" : "2-–ù–û–†–ú–ê");
    Serial.print(",");
    Serial.print(chain3State ? "3-–û–ë–†–´–í" : "3-–ù–û–†–ú–ê");
    Serial.print("]");
    
    Serial.print(" | LED: ");
    Serial.print(ledState ? "ON" : "OFF");
    Serial.print(" | –†–µ–ª–µ: [");
    Serial.print(relay1State ? "1-ON" : "1-OFF");
    Serial.print(",");
    Serial.print(relay2State ? "2-ON" : "2-OFF");
    Serial.print("]");
    
    if (hubConnected) {
        Serial.print(" | RSSI: ");
        Serial.print(WiFi.RSSI());
        Serial.print("dBm");
    }
    
    if (lastReceivedCommand != "") {
        Serial.print(" | –ö–æ–º–∞–Ω–¥–∞: ");
        Serial.print(lastReceivedCommand);
    }
    
    Serial.println();
}

// ======================================================================
// LOOP
// ======================================================================
void loop() {
    unsigned long now = millis();
    
    // 1. –ß—Ç–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ –∏ —Ü–µ–ø–µ–π
    if (now - lastSensorRead >= SENSOR_READ_INTERVAL) {
        readSensors();
        readChains();
        checkAlarmConditions(now);
        lastSensorRead = now;
    }
    
    // 2. –í—ã–≤–æ–¥ –≤ Serial
    if (now - lastSerialPrint >= SERIAL_PRINT_INTERVAL) {
        printToSerial();
        lastSerialPrint = now;
    }
    
    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ LED
    updateStatusLED();
    
    // 4. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ö–∞–± –ø–æ HTTP (–µ—Å–ª–∏ Wi-Fi –ø–æ–¥–∫–ª—é—á–µ–Ω)
    if (hubConnected && now - lastHubSend >= HUB_SEND_INTERVAL) {
        sendToHub(false);
        lastHubSend = now;
    }
    
    // 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (alarmTriggered && hubConnected && (now - lastAlarmSend >= ALARM_COOLDOWN)) {
        sendToHub(true);
        alarmTriggered = false;
        lastAlarmSend = now;
    }
    
    // 6. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Wi-Fi
    if (!hubConnected && now - lastHubSend >= RECONNECT_INTERVAL) {
        Serial.println("‚ôªÔ∏è –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Wi-Fi...");
        setupWiFi();
        lastHubSend = now;
    }
    
    delay(100);
}
