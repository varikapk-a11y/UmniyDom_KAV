// ======================================================================
// –£–ó–ï–õ ‚Ññ2: Uzel_2 (PIR + 2 —Ä–µ–ª–µ) —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
// –í–µ—Ä—Å–∏—è: 2.1 - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
// MAC: 88:56:A6:7C:F2:A8
// ID: 2, –¢–∏–ø: 2 (PIR –¥–∞—Ç—á–∏–∫)
// ======================================================================

#include <esp_now.h>
#include <WiFi.h>

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –£–ó–õ–ê ===
#define NODE_ID_NUM 2        // –ß–∏—Å–ª–æ–≤–æ–π ID —É–∑–ª–∞
#define NODE_TYPE 2          // –¢–∏–ø —É–∑–ª–∞: 2 = PIR –¥–∞—Ç—á–∏–∫
#define FIRMWARE_VER 1       // –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏

// MAC-–∞–¥—Ä–µ—Å —Ö–∞–±–∞ ESP32-S3
uint8_t hubMacAddress[] = {0x9C, 0x13, 0x9E, 0xF2, 0x9D, 0xD8};

// –ü–∏–Ω—ã
#define PIR_PIN 4          // –ü–∏–Ω –¥–∞—Ç—á–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è
#define RELAY_1_PIN 0      // –ü–∏–Ω —Ä–µ–ª–µ 1
#define RELAY_2_PIN 1      // –ü–∏–Ω —Ä–µ–ª–µ 2
#define STATUS_LED 8       // –°–≤–µ—Ç–æ–¥–∏–æ–¥ —Å—Ç–∞—Ç—É—Å–∞
#define VOLTAGE_PIN A0     // –ü–∏–Ω –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–µ–ª–∏—Ç–µ–ª—å)

// –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
#define DATA_SEND_INTERVAL 10000    // 10 —Å–µ–∫
#define PIR_CHECK_INTERVAL 500      // 0.5 —Å–µ–∫
#define DIAGNOSTIC_INTERVAL 30000   // 30 —Å–µ–∫

// –ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–∞
#define STATUS_STARTUP 0
#define STATUS_NORMAL 1
#define STATUS_WARNING 2
#define STATUS_ERROR 3
#define STATUS_CRITICAL 4

// –§–ª–∞–≥–∏ –æ—à–∏–±–æ–∫
#define ERROR_NONE 0x0000
#define ERROR_SENSOR1_FAIL 0x0001
#define ERROR_SENSOR2_FAIL 0x0002
#define ERROR_RELAY1_STUCK 0x0004
#define ERROR_RELAY2_STUCK 0x0008
#define ERROR_LOW_VOLTAGE 0x0010
#define ERROR_HIGH_VOLTAGE 0x0020
#define ERROR_MEMORY_LOW 0x0040
#define ERROR_WIFI_WEAK 0x0080
#define ERROR_OVERHEAT 0x0100

// === –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ö–∞–±–æ–º) ===
#pragma pack(push, 1)
struct EspNowMessage {
    // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    uint32_t sender_id;
    uint8_t node_type;
    uint8_t firmware_ver;
    
    // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
    float value1;
    float value2;
    uint8_t relay1_state;
    uint8_t relay2_state;
    
    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    uint8_t status_code;
    uint16_t error_flags;
    int16_t voltage_mv;
    int8_t rssi_hub;
    int16_t free_heap;
    uint8_t restart_count;
    uint32_t uptime_sec;
    uint32_t packet_count;
    uint32_t timestamp;
};
#pragma pack(pop)

// === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
EspNowMessage outgoingData;
bool relay1State = false;
bool relay2State = false;
bool lastPirState = false;

// –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
struct NodeDiagnostics {
    uint32_t startup_time;
    uint16_t error_flags;
    uint8_t restart_count;
    uint32_t packet_count;
    int16_t min_voltage;
    int16_t max_voltage;
    int8_t min_rssi;
    int8_t max_rssi;
    uint32_t last_error_time;
    uint8_t sensor_fail_count;
    uint16_t voltage_readings[10];
    uint8_t voltage_index;
};

NodeDiagnostics diag;

unsigned long lastSendTime = 0;
unsigned long lastPirCheckTime = 0;
unsigned long lastDiagnosticTime = 0;
unsigned long lastLedBlinkTime = 0;
bool ledState = false;

// === –§–£–ù–ö–¶–ò–ò –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===
// –ß—Ç–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞ - —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–≤–æ—é —Å—Ö–µ–º—É –¥–µ–ª–∏—Ç–µ–ª—è)
int16_t readVoltage() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ–ª–∏—Ç–µ–ª—å –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è –Ω–∞ VOLTAGE_PIN:
    // int adcValue = analogRead(VOLTAGE_PIN);
    // return map(adcValue, 0, 4095, 0, 5000); // –¥–ª—è 5–í
    
    // –ó–∞–≥–ª—É—à–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    return 3300; // 3.3V
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–∑–ª–∞
uint8_t checkNodeHealth() {
    uint8_t status = STATUS_NORMAL;
    uint16_t errors = ERROR_NONE;
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è
    int16_t voltage = readVoltage();
    diag.voltage_readings[diag.voltage_index] = voltage;
    diag.voltage_index = (diag.voltage_index + 1) % 10;
    
    if (voltage < 3000) { // –ù–∏–∂–µ 3.0–í
        errors |= ERROR_LOW_VOLTAGE;
        status = STATUS_CRITICAL;
    } else if (voltage > 3600) { // –í—ã—à–µ 3.6–í
        errors |= ERROR_HIGH_VOLTAGE;
        status = STATUS_CRITICAL;
    }
    
    if (voltage < diag.min_voltage) diag.min_voltage = voltage;
    if (voltage > diag.max_voltage) diag.max_voltage = voltage;
    
    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–º—è—Ç–∏
    int16_t free_mem = ESP.getFreeHeap();
    if (free_mem < 5000) { // –ú–µ–Ω—å—à–µ 5KB
        errors |= ERROR_MEMORY_LOW;
        if (status < STATUS_WARNING) status = STATUS_WARNING;
    }
    
    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—á–∏–∫–∞ PIR
    static uint8_t pir_readings = 0;
    static bool pir_working = true;
    
    if (digitalRead(PIR_PIN) == HIGH) {
        pir_readings = 0;
    } else {
        pir_readings++;
        if (pir_readings > 100) { // –î–∞—Ç—á–∏–∫ –Ω–µ –º–µ–Ω—è–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ 50 —Å–µ–∫
            errors |= ERROR_SENSOR1_FAIL;
            diag.sensor_fail_count++;
            status = STATUS_ERROR;
            pir_working = false;
        } else {
            pir_working = true;
        }
    }
    
    // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ Wi-Fi
    int8_t rssi = WiFi.RSSI();
    if (rssi < -80) { // –°–ª–∞–±—ã–π —Å–∏–≥–Ω–∞–ª
        errors |= ERROR_WIFI_WEAK;
        if (status < STATUS_WARNING) status = STATUS_WARNING;
    }
    
    if (rssi < diag.min_rssi) diag.min_rssi = rssi;
    if (rssi > diag.max_rssi) diag.max_rssi = rssi;
    
    diag.error_flags = errors;
    return status;
}

// –ò–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º
void updateStatusLED(uint8_t status) {
    unsigned long currentMillis = millis();
    
    switch(status) {
        case STATUS_NORMAL:
            // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ (1 —Å–µ–∫ –≤–∫–ª, 1 —Å–µ–∫ –≤—ã–∫–ª)
            if (currentMillis - lastLedBlinkTime > 1000) {
                lastLedBlinkTime = currentMillis;
                ledState = !ledState;
                digitalWrite(STATUS_LED, ledState ? LOW : HIGH);
            }
            break;
            
        case STATUS_WARNING:
            // –ë—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ (0.2 —Å–µ–∫ –≤–∫–ª, 0.2 —Å–µ–∫ –≤—ã–∫–ª)
            if (currentMillis - lastLedBlinkTime > 200) {
                lastLedBlinkTime = currentMillis;
                ledState = !ledState;
                digitalWrite(STATUS_LED, ledState ? LOW : HIGH);
            }
            break;
            
        case STATUS_ERROR:
        case STATUS_CRITICAL:
            // –û—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ (0.1 —Å–µ–∫ –≤–∫–ª, 0.1 —Å–µ–∫ –≤—ã–∫–ª)
            if (currentMillis - lastLedBlinkTime > 100) {
                lastLedBlinkTime = currentMillis;
                ledState = !ledState;
                digitalWrite(STATUS_LED, ledState ? LOW : HIGH);
            }
            break;
            
        default:
            digitalWrite(STATUS_LED, HIGH); // –í—ã–∫–ª—é—á–µ–Ω
            break;
    }
}

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ESP-NOW ===
void OnDataSent(const esp_now_send_info_t *send_info, esp_now_send_status_t status) {
    const uint8_t* mac_addr = send_info->des_addr;
    
    Serial.print("üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ö–∞–±—É: ");
    Serial.println(status == ESP_NOW_SEND_SUCCESS ? "–£—Å–ø–µ—Ö" : "–û—à–∏–±–∫–∞");
}

void OnDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len) {
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Ö–∞–±–∞
    typedef struct __attribute__((packed)) {
        char command[16];
        int relay_num;
        int value;
    } node_command_t;
    
    if (len == sizeof(node_command_t)) {
        node_command_t cmd;
        memcpy(&cmd, incomingData, sizeof(cmd));
        
        Serial.print("üì® –ö–æ–º–∞–Ω–¥–∞ –æ—Ç —Ö–∞–±–∞: ");
        Serial.print(cmd.command);
        Serial.print(" –¥–ª—è —Ä–µ–ª–µ ");
        Serial.println(cmd.relay_num);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        int relayPin = (cmd.relay_num == 1) ? RELAY_1_PIN : RELAY_2_PIN;
        bool *relayState = (cmd.relay_num == 1) ? &relay1State : &relay2State;
        
        if (strcmp(cmd.command, "relay_on") == 0) {
            digitalWrite(relayPin, HIGH);
            *relayState = true;
            Serial.println("‚úÖ –†–µ–ª–µ –í–ö–õ");
        } else if (strcmp(cmd.command, "relay_off") == 0) {
            digitalWrite(relayPin, LOW);
            *relayState = false;
            Serial.println("‚úÖ –†–µ–ª–µ –í–´–ö–õ");
        } else if (strcmp(cmd.command, "relay_toggle") == 0) {
            *relayState = !(*relayState);
            digitalWrite(relayPin, (*relayState) ? HIGH : LOW);
            Serial.println("‚úÖ –†–µ–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ");
        } else if (strcmp(cmd.command, "get_diagnostic") == 0) {
            sendDiagnosticData();
            return;
        }
        
        sendDataToHub();
    }
}

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
void sendDataToHub() {
    EspNowMessage msg;
    
    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    msg.sender_id = NODE_ID_NUM;
    msg.node_type = NODE_TYPE;
    msg.firmware_ver = FIRMWARE_VER;
    
    // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
    msg.value1 = (digitalRead(PIR_PIN) == HIGH) ? 1.0 : 0.0;
    msg.value2 = 0.0;
    msg.relay1_state = relay1State ? 1 : 0;
    msg.relay2_state = relay2State ? 1 : 0;
    
    // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    msg.status_code = checkNodeHealth();
    msg.error_flags = diag.error_flags;
    msg.voltage_mv = readVoltage();
    msg.rssi_hub = WiFi.RSSI();
    msg.free_heap = ESP.getFreeHeap();
    msg.restart_count = diag.restart_count;
    msg.uptime_sec = (millis() - diag.startup_time) / 1000;
    msg.packet_count = ++diag.packet_count;
    msg.timestamp = millis();
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞
    esp_err_t result = esp_now_send(hubMacAddress, (uint8_t*)&msg, sizeof(msg));
    
    if (result == ESP_OK) {
        Serial.println("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã");
    } else {
        Serial.print("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ");
        Serial.println(esp_err_to_name(result));
    }
}

void sendDiagnosticData() {
    EspNowMessage msg;
    
    // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    msg.sender_id = NODE_ID_NUM;
    msg.node_type = NODE_TYPE;
    msg.firmware_ver = FIRMWARE_VER;
    
    // –î–∞–Ω–Ω—ã–µ
    msg.value1 = (digitalRead(PIR_PIN) == HIGH) ? 1.0 : 0.0;
    msg.value2 = diag.sensor_fail_count;
    msg.relay1_state = relay1State ? 1 : 0;
    msg.relay2_state = relay2State ? 1 : 0;
    
    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    msg.status_code = checkNodeHealth();
    msg.error_flags = diag.error_flags;
    
    // –°—Ä–µ–¥–Ω–µ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ
    int32_t voltage_sum = 0;
    for (int i = 0; i < 10; i++) {
        voltage_sum += diag.voltage_readings[i];
    }
    msg.voltage_mv = voltage_sum / 10;
    
    msg.rssi_hub = WiFi.RSSI();
    msg.free_heap = ESP.getFreeHeap();
    msg.restart_count = diag.restart_count;
    msg.uptime_sec = (millis() - diag.startup_time) / 1000;
    msg.packet_count = ++diag.packet_count;
    msg.timestamp = millis();
    
    esp_now_send(hubMacAddress, (uint8_t*)&msg, sizeof(msg));
    Serial.println("üìä –û—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ");
}

void printDiagnosticInfo() {
    Serial.println("\n=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –£–ó–õ–ê ===");
    Serial.print("–ê–ø—Ç–∞–π–º: ");
    Serial.print((millis() - diag.startup_time) / 1000);
    Serial.println(" —Å–µ–∫");
    
    Serial.print("–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ: ");
    Serial.print(readVoltage());
    Serial.println(" mV");
    
    Serial.print("–ü–∞–º—è—Ç—å: ");
    Serial.print(ESP.getFreeHeap());
    Serial.println(" –±–∞–π—Ç");
    
    Serial.print("RSSI: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
    
    Serial.print("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∞–∫–µ—Ç–æ–≤: ");
    Serial.println(diag.packet_count);
    
    Serial.print("–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫: ");
    Serial.println(diag.restart_count);
    
    Serial.print("–û—à–∏–±–æ–∫ –¥–∞—Ç—á–∏–∫–∞: ");
    Serial.println(diag.sensor_fail_count);
    
    Serial.print("–°—Ç–∞—Ç—É—Å: ");
    switch(checkNodeHealth()) {
        case STATUS_NORMAL: Serial.println("–ù–û–†–ú–ê"); break;
        case STATUS_WARNING: Serial.println("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï"); break;
        case STATUS_ERROR: Serial.println("–û–®–ò–ë–ö–ê"); break;
        case STATUS_CRITICAL: Serial.println("–ö–†–ò–¢–ò–ß–ï–°–ö–û"); break;
        default: Serial.println("–ù–ï–ò–ó–í–ï–°–¢–ù–û");
    }
    
    Serial.println("=======================\n");
}

// === SETUP ===
void setup() {
    Serial.begin(115200);
    delay(1000);
    
    Serial.println("\n" + String(80, '='));
    Serial.println("üöÄ –£–ó–ï–õ #2: Uzel_2 (PIR + 2 —Ä–µ–ª–µ)");
    Serial.println("–í–µ—Ä—Å–∏—è: 2.1 - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥");
    Serial.println(String(80, '='));
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    diag.startup_time = millis();
    diag.restart_count = 0; // –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —á–∏—Ç–∞—Ç—å –∏–∑ EEPROM
    diag.packet_count = 0;
    diag.min_voltage = 5000;
    diag.max_voltage = 0;
    diag.min_rssi = 0;
    diag.max_rssi = -100;
    diag.sensor_fail_count = 0;
    diag.voltage_index = 0;
    for (int i = 0; i < 10; i++) diag.voltage_readings[i] = 3300;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
    pinMode(PIR_PIN, INPUT);
    pinMode(RELAY_1_PIN, OUTPUT);
    pinMode(RELAY_2_PIN, OUTPUT);
    pinMode(STATUS_LED, OUTPUT);
    
    digitalWrite(RELAY_1_PIN, LOW);
    digitalWrite(RELAY_2_PIN, LOW);
    digitalWrite(STATUS_LED, HIGH); // –í—ã–∫–ª—é—á–µ–Ω
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Wi-Fi –∏ ESP-NOW
    WiFi.mode(WIFI_STA);
    WiFi.disconnect();
    
    if (esp_now_init() != ESP_OK) {
        Serial.println("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ESP-NOW!");
        while (1) {
            digitalWrite(STATUS_LED, LOW);
            delay(100);
            digitalWrite(STATUS_LED, HIGH);
            delay(100);
        }
    }
    
    esp_now_register_send_cb(OnDataSent);
    esp_now_register_recv_cb(OnDataRecv);
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–∞–±–∞
    esp_now_peer_info_t peerInfo;
    memset(&peerInfo, 0, sizeof(peerInfo));
    memcpy(peerInfo.peer_addr, hubMacAddress, 6);
    peerInfo.channel = 1;
    peerInfo.encrypt = false;
    
    if (esp_now_add_peer(&peerInfo) != ESP_OK) {
        Serial.println("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–∞–±!");
    } else {
        Serial.println("‚úÖ –•–∞–± –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
    }
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    checkNodeHealth();
    printDiagnosticInfo();
    
    Serial.println("‚úÖ –£–∑–µ–ª –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");
    Serial.println(String(80, '=') + "\n");
}

// === LOOP ===
void loop() {
    unsigned long currentMillis = millis();
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—á–∏–∫–∞ PIR
    if (currentMillis - lastPirCheckTime > PIR_CHECK_INTERVAL) {
        lastPirCheckTime = currentMillis;
        bool currentPirState = (digitalRead(PIR_PIN) == HIGH);
        
        if (currentPirState != lastPirState) {
            Serial.println(currentPirState ? "üî¥ –î–í–ò–ñ–ï–ù–ò–ï!" : "üü¢ –ü–æ–∫–æ–π");
            lastPirState = currentPirState;
            sendDataToHub();
        }
    }
    
    // 2. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    if (currentMillis - lastSendTime > DATA_SEND_INTERVAL) {
        lastSendTime = currentMillis;
        sendDataToHub();
    }
    
    // 3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
    if (currentMillis - lastDiagnosticTime > DIAGNOSTIC_INTERVAL) {
        lastDiagnosticTime = currentMillis;
        printDiagnosticInfo();
    }
    
    // 4. –ò–Ω–¥–∏–∫–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞
    updateStatusLED(checkNodeHealth());
    
    delay(10);
}
