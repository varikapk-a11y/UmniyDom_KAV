// –£–ó–ï–õ #2 (ESP32-C3) –¥–ª—è Smart Home Hub
// MAC —É–∑–ª–∞: 88:56:A6:7C:F2:A8
// –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: PIR –¥–∞—Ç—á–∏–∫ + 2 —Ä–µ–ª–µ

#include <esp_now.h>
#include <WiFi.h>

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –£–ó–õ–ê ===
#define NODE_ID "PIR_Corridor"     // –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –≤ —Ö–∞–±–µ!
#define NODE_TYPE 2                // 2 = PIR –¥–∞—Ç—á–∏–∫ (–ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É —Ö–∞–±–∞)

// MAC-–∞–¥—Ä–µ—Å —Ö–∞–±–∞ ESP32-S3 (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô MAC!)
uint8_t hubMacAddress[] = {0x9C, 0x13, 0x9E, 0xF2, 0x9D, 0xD8};

// –ü–∏–Ω—ã (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥ —Å–≤–æ—é —Å—Ö–µ–º—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
#define PIR_PIN 4          // –ü–∏–Ω –¥–∞—Ç—á–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è (INPUT)
#define RELAY_1_PIN 0      // –ü–∏–Ω –¥–ª—è —Ä–µ–ª–µ 1 (GPIO0)
#define RELAY_2_PIN 1      // –ü–∏–Ω –¥–ª—è —Ä–µ–ª–µ 2 (GPIO1)
#define STATUS_LED 8       // –°–≤–µ—Ç–æ–¥–∏–æ–¥ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π/–≤–Ω–µ—à–Ω–∏–π)

// –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–º—Å) –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ PIR
#define DATA_SEND_INTERVAL 10000
#define PIR_CHECK_INTERVAL 500

// === –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• (–î–û–õ–ñ–ù–ê –°–û–í–ü–ê–î–ê–¢–¨ –° –•–ê–ë–û–ú!) ===
typedef struct __attribute__((packed)) {
  char node_id[32];
  uint8_t node_type;
  float value1;          // –û—Å–Ω–æ–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–¥–ª—è PIR: 1.0=–¥–≤–∏–∂–µ–Ω–∏–µ, 0.0=–ø–æ–∫–æ–π)
  float value2;          // –î–æ–ø. –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å)
  uint8_t relay1_state;  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ 1 (1=–í–ö–õ, 0=–í–´–ö–õ)
  uint8_t relay2_state;  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ª–µ 2
  uint8_t status;        // –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫)
  uint32_t timestamp;
} espnow_message_t;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
espnow_message_t outgoingData;
bool relay1State = false;
bool relay2State = false;
bool lastPirState = false;
unsigned long lastSendTime = 0;
unsigned long lastPirCheckTime = 0;

// === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ESP-NOW ===
// Callback –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö
void OnDataSent(const uint8_t *mac_addr, esp_now_send_status_t status) {
  Serial.print("–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ö–∞–±—É: ");
  Serial.println(status == ESP_NOW_SEND_SUCCESS ? "–£—Å–ø–µ—Ö ‚úÖ" : "–û—à–∏–±–∫–∞ ‚ùå");
  digitalWrite(STATUS_LED, (status == ESP_NOW_SEND_SUCCESS) ? LOW : HIGH);
  delay(50);
  digitalWrite(STATUS_LED, HIGH);
}

// Callback –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö (–ö–û–ú–ê–ù–î –æ—Ç —Ö–∞–±–∞)
void OnDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len) {
  // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Ö–∞–±–∞ (–ø—Ä–∏–º–µ—Ä)
  typedef struct __attribute__((packed)) {
    char command[16];  // "relay_on", "relay_off", "relay_toggle"
    int relay_num;     // –ù–æ–º–µ—Ä —Ä–µ–ª–µ (1 –∏–ª–∏ 2)
    int value;
  } node_command_t;

  if (len == sizeof(node_command_t)) {
    node_command_t cmd;
    memcpy(&cmd, incomingData, sizeof(cmd));
    Serial.print("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ—Ç —Ö–∞–±–∞: ");
    Serial.print(cmd.command);
    Serial.print(" –¥–ª—è —Ä–µ–ª–µ ");
    Serial.println(cmd.relay_num);

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
    int relayPin = (cmd.relay_num == 1) ? RELAY_1_PIN : RELAY_2_PIN;
    bool *relayState = (cmd.relay_num == 1) ? &relay1State : &relay2State;

    if (strcmp(cmd.command, "relay_on") == 0) {
      digitalWrite(relayPin, HIGH);
      *relayState = true;
      Serial.println("–†–µ–ª–µ –í–ö–õ");
    } else if (strcmp(cmd.command, "relay_off") == 0) {
      digitalWrite(relayPin, LOW);
      *relayState = false;
      Serial.println("–†–µ–ª–µ –í–´–ö–õ");
    } else if (strcmp(cmd.command, "relay_toggle") == 0) {
      *relayState = !(*relayState);
      digitalWrite(relayPin, (*relayState) ? HIGH : LOW);
      Serial.println("–†–µ–ª–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ");
    }
    // –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö–∞–±—É
    sendDataToHub();
  }
}

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ö–∞–±
void sendDataToHub() {
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã–º–∏
  strncpy(outgoingData.node_id, NODE_ID, sizeof(outgoingData.node_id));
  outgoingData.node_type = NODE_TYPE;
  outgoingData.value1 = (digitalRead(PIR_PIN) == HIGH) ? 1.0 : 0.0;
  outgoingData.value2 = 0.0; // –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è PIR
  outgoingData.relay1_state = relay1State ? 1 : 0;
  outgoingData.relay2_state = relay2State ? 1 : 0;
  outgoingData.status = 1; // –°—Ç–∞—Ç—É—Å "–≤—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ"
  outgoingData.timestamp = millis();

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ ESP-NOW
  esp_err_t result = esp_now_send(hubMacAddress, (uint8_t *)&outgoingData, sizeof(outgoingData));
  if (result != ESP_OK) {
    Serial.println("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ESP-NOW!");
  }
}

// === SETUP ===
void setup() {
  Serial.begin(115200);
  delay(1000); // –î–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Serial
  Serial.println("\n=== –£–ó–ï–õ #2: PIR + 2 —Ä–µ–ª–µ ===");
  Serial.println("MAC: 88:56:A6:7C:F2:A8");

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
  pinMode(PIR_PIN, INPUT);
  pinMode(RELAY_1_PIN, OUTPUT);
  pinMode(RELAY_2_PIN, OUTPUT);
  pinMode(STATUS_LED, OUTPUT);
  digitalWrite(RELAY_1_PIN, LOW);
  digitalWrite(RELAY_2_PIN, LOW);
  digitalWrite(STATUS_LED, HIGH); // LED –≤—ã–∫–ª (–∞–∫—Ç–∏–≤–Ω—ã–π LOW)

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Wi-Fi –∏ ESP-NOW
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();

  if (esp_now_init() != ESP_OK) {
    Serial.println("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ESP-NOW!");
    while (1) delay(100);
  }

  esp_now_register_send_cb(OnDataSent);
  esp_now_register_recv_cb(OnDataRecv);

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–∞–±–∞ –∫–∞–∫ –ø–∏—Ä–∞
  esp_now_peer_info_t peerInfo;
  memset(&peerInfo, 0, sizeof(peerInfo));
  memcpy(peerInfo.peer_addr, hubMacAddress, 6);
  peerInfo.channel = 1;
  peerInfo.encrypt = false;
  if (esp_now_add_peer(&peerInfo) != ESP_OK) {
    Serial.println("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ö–∞–±!");
  } else {
    Serial.println("‚úÖ –•–∞–± –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –£–∑–µ–ª –≥–æ—Ç–æ–≤.");
  }
}

// === LOOP ===
void loop() {
  unsigned long currentMillis = millis();

  // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—á–∏–∫–∞ PIR (—á–∞—Å—Ç–æ, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º)
  if (currentMillis - lastPirCheckTime > PIR_CHECK_INTERVAL) {
    lastPirCheckTime = currentMillis;
    bool currentPirState = (digitalRead(PIR_PIN) == HIGH);
    if (currentPirState != lastPirState) {
      Serial.println(currentPirState ? "üî¥ –î–í–ò–ñ–ï–ù–ò–ï!" : "üü¢ –ü–æ–∫–æ–π");
      lastPirState = currentPirState;
      // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è PIR —Å—Ä–∞–∑—É —à–ª–µ–º –¥–∞–Ω–Ω—ã–µ
      sendDataToHub();
    }
  }

  // 2. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–ª–æ—Å—å)
  if (currentMillis - lastSendTime > DATA_SEND_INTERVAL) {
    lastSendTime = currentMillis;
    sendDataToHub();
    Serial.println("üì§ –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ö–∞–±—É");
  }

  delay(10); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
}
