// –ö–û–ù–§–ò–ì –î–õ–Ø –£–ó–õ–ê #4 (ESP32-C3 #4)
// MAC: 10:00:3B:B1:A6:9C
// IP: 192.168.4.104
// ======================================================================

// ---------------- –ù–ê–°–¢–†–û–ô–ö–ê –°–ï–¢–ò –ò ESP-NOW ----------------
const uint32_t NODE_ID = 4;                    // –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID
IPAddress local_IP(192, 168, 4, 104);         // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP (.104)
IPAddress gateway(192, 168, 4, 1);
IPAddress subnet(255, 255, 255, 0);
const char* SSID = "ESP32_Hub_Network";
const char* PASSWORD = "node12345678";
const String HUB_IP = "192.168.4.1";

// MAC-–∞–¥—Ä–µ—Å —Ö–∞–±–∞ (–ù–ï –ú–ï–ù–Ø–¢–¨!)
uint8_t hubMacAddress[] = {0x9C, 0x9C, 0x1F, 0xC7, 0x2D, 0x94};

// ---------------- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–ê–¢–ß–ò–ö–û–í ----------------
// true = –¥–∞—Ç—á–∏–∫ –ü–û–î–ö–õ–Æ–ß–ï–ù, false = –û–¢–°–£–¢–°–¢–í–£–ï–¢
#define USE_CJMCU8128       false
#define USE_MQ4             false
#define USE_MQ7             false
#define USE_VL53L0X         false
#define USE_TINY_RTC        false
#define USE_INDUCTIVE_SENSOR false

#define USE_AHT10           false
#define USE_BMP280          false
#define USE_CCS811          false
#define USE_BH1750          false
#define USE_PIR             false
#define USE_DOOR_SENSOR     false
#define USE_WATER_SENSOR    false
#define USE_SOUND_SENSOR    false

// ---------------- (C) –ù–ê–°–¢–†–û–ô–ö–ê –°–ï–¢–ò –ò ESP-NOW ----------------
const uint32_t NODE_ID = 1;         // –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (1,2,3...)
IPAddress local_IP(192, 168, 4, 102); // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP (.102, .103...)
IPAddress gateway(192, 168, 4, 1);
IPAddress subnet(255, 255, 255, 0);
const char* SSID = "ESP32_Hub_Network";
const char* PASSWORD = "node12345678";
const String HUB_IP = "192.168.4.1";

// MAC-–∞–¥—Ä–µ—Å —Ö–∞–±–∞ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–´–ô –ú–ê–ö –•–ê–ë–ê!)
uint8_t hubMacAddress[] = {0x9C, 0x9C, 0x1F, 0xC7, 0x2D, 0x94};

// ---------------- (D) –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –ü–ò–ù–û–í ----------------
// I2C —à–∏–Ω–∞
const uint8_t PIN_SDA = 8;
const uint8_t PIN_SCL = 9;

// –ê–Ω–∞–ª–æ–≥–æ–≤—ã–µ –≤—Ö–æ–¥—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è MQ-4/MQ-7!)
const uint8_t PIN_MQ4_ANALOG = 2;
const uint8_t PIN_MQ7_ANALOG = 3;

// –¶–∏—Ñ—Ä–æ–≤—ã–µ –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã
const uint8_t PIN_PIR = 4;
const uint8_t PIN_DOOR = 5;
const uint8_t PIN_WATER = 6;
const uint8_t PIN_SOUND = 7;
const uint8_t PIN_INDUCTIVE = 10;

// –í–∞—à–∏ —Ü–µ–ø–∏
#define CHAIN_1_PIN 18
#define CHAIN_2_PIN 19
#define CHAIN_3_PIN 20

// –†–µ–ª–µ/—É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –≤—ã—Ö–æ–¥—ã (–ø—Ä–∏–º–µ—Ä)
#define RELAY_1_PIN 0    // GPIO0 –¥–ª—è —Ä–µ–ª–µ 1
#define RELAY_2_PIN 1    // GPIO1 –¥–ª—è —Ä–µ–ª–µ 2
#define LED_PIN 8        // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π LED –Ω–∞ ESP32-C3

// ======================================================================
// –†–ê–ó–î–ï–õ 2: –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–• ESP-NOW
// ======================================================================

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö ESP-NOW (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ö–∞–±–æ–º!)
typedef struct esp_now_message {
    char command[16];    // "LED_ON", "LED_OFF", "RELAY_1_ON", "ACK_ON", –∏ —Ç.–¥.
    uint8_t sender_id;   // ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    uint8_t target_id;   // ID —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞
} esp_now_message;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ESP-NOW
esp_now_message incomingMessage;
esp_now_message outgoingMessage;

// ======================================================================
// –†–ê–ó–î–ï–õ 3: –û–ë–™–Ø–í–õ–ï–ù–ò–ï –ì–õ–û–ë–ê–õ–¨–ù–´–• –û–ë–™–ï–ö–¢–û–í –î–ê–¢–ß–ò–ö–û–í
// ======================================================================
#ifdef USE_CJMCU8128
  CCS811 ccs(0x5A);
  Weather si7021;
  Adafruit_BMP280 bmp;
#endif
#ifdef USE_VL53L0X
  Adafruit_VL53L0X vl53 = Adafruit_VL53L0X();
#endif
#ifdef USE_TINY_RTC
  RTC_DS1307 rtc;
#endif
#ifdef USE_AHT10
  Adafruit_AHTX aht;
#endif
#ifdef USE_BMP280
  Adafruit_BMP280 bmp_standalone;
#endif
#ifdef USE_CCS811
  CCS811 ccs_standalone(0x5A);
#endif
#ifdef USE_BH1750
  BH1750 lightMeter;
#endif

// ======================================================================
// –†–ê–ó–î–ï–õ 4: –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–• –í–°–ï–• –î–ê–¢–ß–ò–ö–û–í
// ======================================================================
struct SensorData {
  // CJMCU-8128 –∏ –∞–Ω–∞–ª–æ–≥–∏
  float tempCJMCU = NAN;
  float humCJMCU = NAN;
  float pressureCJMCU = NAN;
  float co2CJMCU = NAN;
  float tvocCJMCU = NAN;
  
  // –ê–Ω–∞–ª–æ–≥–æ–≤—ã–µ –¥–∞—Ç—á–∏–∫–∏
  float mq4Value = NAN;
  float mq7Value = NAN;
  
  // VL53L0X
  float distanceMM = NAN;
  
  // Tiny RTC
  String timestamp = "";
  
  // –ò–Ω–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–∞—Ç—á–∏–∫
  uint8_t inductiveState = 0;
  
  // –ë–∞–∑–æ–≤—ã–µ –¥–∞—Ç—á–∏–∫–∏
  float tempAHT = NAN;
  float humAHT = NAN;
  float pressureBMP = NAN;
  float co2CCS = NAN;
  float tvocCCS = NAN;
  float lux = NAN;
  uint8_t pirState = 0;
  uint8_t doorState = 0;
  uint8_t waterState = 0;
  uint8_t soundState = 0;
  
  // –¶–µ–ø–∏
  int chain1 = 0;
  int chain2 = 0;
  int chain3 = 0;
  
  // –†–µ–ª–µ/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  bool relay1State = false;
  bool relay2State = false;
  bool ledState = false;
  
  // –°–∏—Å—Ç–µ–º–Ω—ã–µ
  int rssi = 0;
  int freeHeap = 0;
};

SensorData data;

// ======================================================================
// –†–ê–ó–î–ï–õ 5: –°–ò–°–¢–ï–ú–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ======================================================================
unsigned long lastDataSend = 0;
const unsigned long DATA_SEND_INTERVAL = 10000;
unsigned long lastEmergencySend = 0;
const unsigned long EMERGENCY_COOLDOWN = 2000;
unsigned long mq7HeatingStart = 0;
const unsigned long MQ7_HEATING_TIME = 172800000;

// –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
bool wifiConnected = false;
bool espNowInitialized = false;
String lastReceivedCommand = "";

// –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã —Ñ—É–Ω–∫—Ü–∏–π ESP-NOW
void onEspNowDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len);
void onEspNowDataSent(const wifi_tx_info_t *info, esp_now_send_status_t status);
void sendAckToHub(const char* ackCommand);
void processCommand(String command);
void setupESP_NOW();
// ======================================================================
// –†–ê–ó–î–ï–õ 6: –ù–ê–°–¢–†–û–ô–ö–ê –î–ê–¢–ß–ò–ö–û–í (SETUP_SENSORS)
// ======================================================================
void setupSensors() {
  Serial.println("=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢–ß–ò–ö–û–í ===");
  Wire.begin(PIN_SDA, PIN_SCL);
  
  #ifdef USE_CJMCU8128
    Serial.print("CJMCU-8128... ");
    if (ccs.begin() && si7021.begin() && bmp.begin(0x76)) {
      Serial.println("OK");
      ccs.setDriveMode(CCS811_DRIVE_MODE_10SEC);
    } else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  
  #ifdef USE_MQ4
    pinMode(PIN_MQ4_ANALOG, INPUT);
    Serial.println("MQ-4: –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç 5–í!)");
  #endif
  
  #ifdef USE_MQ7
    pinMode(PIN_MQ7_ANALOG, INPUT);
    mq7HeatingStart = millis();
    Serial.println("MQ-7: –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø—Ä–æ–≥—Ä–µ–≤ 48—á)");
  #endif
  
  #ifdef USE_VL53L0X
    Serial.print("VL53L0X... ");
    if (vl53.begin()) {
      Serial.println("OK");
      vl53.startRangeContinuous();
    } else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  
  #ifdef USE_TINY_RTC
    Serial.print("Tiny RTC... ");
    if (rtc.begin()) {
      Serial.println("OK");
      if (!rtc.isrunning()) {
        rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
      }
    } else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  
  #ifdef USE_INDUCTIVE_SENSOR
    pinMode(PIN_INDUCTIVE, INPUT_PULLUP);
    Serial.println("–ò–Ω–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–∞—Ç—á–∏–∫: –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
  #endif
  
  // –ë–∞–∑–æ–≤—ã–µ –¥–∞—Ç—á–∏–∫–∏
  #ifdef USE_AHT10
    Serial.print("AHT10... ");
    if (aht.begin()) Serial.println("OK"); else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  #ifdef USE_BMP280
    Serial.print("BMP280... ");
    if (bmp_standalone.begin(0x76)) Serial.println("OK"); else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  #ifdef USE_CCS811
    Serial.print("CCS811... ");
    if (ccs_standalone.begin()) Serial.println("OK"); else Serial.println("–û–®–ò–ë–ö–ê!");
  #endif
  #ifdef USE_BH1750
    Serial.print("BH1750... ");
    lightMeter.begin();
    Serial.println("OK");
  #endif
  
  #ifdef USE_PIR
    pinMode(PIN_PIR, INPUT);
    Serial.println("PIR: –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
  #endif
  #ifdef USE_DOOR_SENSOR
    pinMode(PIN_DOOR, INPUT_PULLUP);
    Serial.println("–î–≤–µ—Ä—å: –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
  #endif
  #ifdef USE_WATER_SENSOR
    pinMode(PIN_WATER, INPUT_PULLUP);
    Serial.println("–í–æ–¥–∞: –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
  #endif
  #ifdef USE_SOUND_SENSOR
    pinMode(PIN_SOUND, INPUT);
    Serial.println("–ó–≤—É–∫: –Ω–∞—Å—Ç—Ä–æ–µ–Ω");
  #endif
  
  // –¶–µ–ø–∏
  pinMode(CHAIN_1_PIN, INPUT_PULLUP);
  pinMode(CHAIN_2_PIN, INPUT_PULLUP);
  pinMode(CHAIN_3_PIN, INPUT_PULLUP);
  
  // –í—ã—Ö–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, HIGH); // LED –≤—ã–∫–ª—é—á–µ–Ω (–∞–∫—Ç–∏–≤–Ω—ã–π LOW)
  
  #ifdef RELAY_1_PIN
    pinMode(RELAY_1_PIN, OUTPUT);
    digitalWrite(RELAY_1_PIN, LOW); // –†–µ–ª–µ –≤—ã–∫–ª—é—á–µ–Ω–æ
  #endif
  
  #ifdef RELAY_2_PIN
    pinMode(RELAY_2_PIN, OUTPUT);
    digitalWrite(RELAY_2_PIN, LOW);
  #endif
  
  Serial.println("=== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢–ß–ò–ö–û–í –ó–ê–í–ï–†–®–ï–ù–ê ===\n");
}

// ======================================================================
// –†–ê–ó–î–ï–õ 7: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ESP-NOW
// ======================================================================
void setupESP_NOW() {
  WiFi.mode(WIFI_STA);
  
  // –£–°–¢–ê–ù–û–í–ö–ê –ú–ò–ù–ò–ú–ê–õ–¨–ù–û–ô –ú–û–©–ù–û–°–¢–ò –î–õ–Ø –°–ù–ò–ñ–ï–ù–ò–Ø –ù–ê–ì–†–ï–í–ê
  // WIFI_POWER_8_5dBm = ~7 –º–í—Ç (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–≥—Ä–µ–≤)
  WiFi.setTxPower(WIFI_POWER_8_5dBm);
  
  Serial.print("–ú–æ—â–Ω–æ—Å—Ç—å Wi-Fi —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ");
  switch(WiFi.getTxPower()) {
    case WIFI_POWER_8_5dBm: Serial.println("8.5 dBm (~7 –º–í—Ç)"); break;
    case WIFI_POWER_11dBm: Serial.println("11 dBm (~13 –º–í—Ç)"); break;
    case WIFI_POWER_13dBm: Serial.println("13 dBm (~20 –º–í—Ç)"); break;
    case WIFI_POWER_15dBm: Serial.println("15 dBm (~32 –º–í—Ç)"); break;
    case WIFI_POWER_17dBm: Serial.println("17 dBm (~50 –º–í—Ç)"); break;
    case WIFI_POWER_19_5dBm: Serial.println("19.5 dBm (~90 –º–í—Ç)"); break;
    default: Serial.println("–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
  }
  
  if (esp_now_init() != ESP_OK) {
    Serial.println("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ESP-NOW!");
    espNowInitialized = false;
    return;
  }
  
  esp_now_register_recv_cb(onEspNowDataRecv);
  esp_now_register_send_cb(onEspNowDataSent);
  
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–∞–±–∞ –∫–∞–∫ –ø–∏—Ä–∞
  esp_now_peer_info_t peerInfo = {};
  memcpy(peerInfo.peer_addr, hubMacAddress, 6);
  peerInfo.channel = 0;
  peerInfo.encrypt = false;
  
  if (esp_now_add_peer(&peerInfo) == ESP_OK) {
    Serial.println("‚úÖ –•–∞–± –¥–æ–±–∞–≤–ª–µ–Ω –≤ ESP-NOW");
    espNowInitialized = true;
  } else {
    Serial.println("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ö–∞–± –≤ ESP-NOW");
    espNowInitialized = false;
  }
}

// ======================================================================
// –†–ê–ó–î–ï–õ 8: –§–£–ù–ö–¶–ò–ò –ß–¢–ï–ù–ò–Ø –î–ê–¢–ß–ò–ö–û–í (–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)
// ======================================================================
void readCJMCU8128() {
  #ifdef USE_CJMCU8128
    data.tempCJMCU = si7021.getTemp();
    data.humCJMCU = si7021.getRH();
    data.pressureCJMCU = bmp.readPressure() / 100.0F;
    if (ccs.dataAvailable()) {
      ccs.readAlgorithmResults();
      data.co2CJMCU = ccs.getCO2();
      data.tvocCJMCU = ccs.getTVOC();
    }
  #endif
}

void readMQ4() {
  #ifdef USE_MQ4
    int raw = analogRead(PIN_MQ4_ANALOG);
    data.mq4Value = (raw > 620) ? (raw - 620) / (4095 - 620) * 100.0 : 0.0;
  #endif
}

void readMQ7() {
  #ifdef USE_MQ7
    if (millis() - mq7HeatingStart < MQ7_HEATING_TIME) {
      data.mq7Value = NAN;
      return;
    }
    int raw = analogRead(PIN_MQ7_ANALOG);
    data.mq7Value = (raw > 620) ? (raw - 620) / (4095 - 620) * 100.0 : 0.0;
  #endif
}

void readVL53L0X() {
  #ifdef USE_VL53L0X
    if (vl53.isRangeComplete()) {
      data.distanceMM = vl53.readRange();
      if (data.distanceMM > 2000) data.distanceMM = NAN;
    }
  #endif
}

void readTinyRTC() {
  #ifdef USE_TINY_RTC
    DateTime now = rtc.now();
    data.timestamp = "";
    data.timestamp += now.year(); data.timestamp += "-";
    if (now.month() < 10) data.timestamp += "0";
    data.timestamp += now.month(); data.timestamp += "-";
    if (now.day() < 10) data.timestamp += "0";
    data.timestamp += now.day(); data.timestamp += " ";
    if (now.hour() < 10) data.timestamp += "0";
    data.timestamp += now.hour(); data.timestamp += ":";
    if (now.minute() < 10) data.timestamp += "0";
    data.timestamp += now.minute(); data.timestamp += ":";
    if (now.second() < 10) data.timestamp += "0";
    data.timestamp += now.second();
  #endif
}

void readInductiveSensor() {
  #ifdef USE_INDUCTIVE_SENSOR
    data.inductiveState = !digitalRead(PIN_INDUCTIVE);
  #endif
}

void readBaseSensors() {
  #ifdef USE_AHT10
    sensors_event_t humidity, temp;
    aht.getEvent(&humidity, &temp);
    data.tempAHT = temp.temperature;
    data.humAHT = humidity.relative_humidity;
  #endif
  
  #ifdef USE_BMP280
    data.pressureBMP = bmp_standalone.readPressure() / 100.0F;
  #endif
  
  #ifdef USE_CCS811
    if (ccs_standalone.dataAvailable()) {
      ccs_standalone.readAlgorithmResults();
      data.co2CCS = ccs_standalone.getCO2();
      data.tvocCCS = ccs_standalone.getTVOC();
    }
  #endif
  
  #ifdef USE_BH1750
    data.lux = lightMeter.readLightLevel();
  #endif
  
  #ifdef USE_PIR
    data.pirState = digitalRead(PIN_PIR);
  #endif
  #ifdef USE_DOOR_SENSOR
    data.doorState = !digitalRead(PIN_DOOR);
  #endif
  #ifdef USE_WATER_SENSOR
    data.waterState = !digitalRead(PIN_WATER);
  #endif
  #ifdef USE_SOUND_SENSOR
    data.soundState = digitalRead(PIN_SOUND);
  #endif
}

void readChains() {
  data.chain1 = digitalRead(CHAIN_1_PIN);
  data.chain2 = digitalRead(CHAIN_2_PIN);
  data.chain3 = digitalRead(CHAIN_3_PIN);
}

void readAllSensors() {
  readCJMCU8128();
  readMQ4();
  readMQ7();
  readVL53L0X();
  readTinyRTC();
  readInductiveSensor();
  readBaseSensors();
  readChains();
  
  data.rssi = WiFi.RSSI();
  data.freeHeap = ESP.getFreeHeap();
}
// ======================================================================
// –†–ê–ó–î–ï–õ 9: –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ù–ê –•–ê–ë –ò –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î
// ======================================================================

void sendDataToHub(bool isEmergency = false) {
  if (!wifiConnected) {
    Serial.println("! Wi-Fi –æ—Ç–∫–ª—é—á–µ–Ω. –î–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.");
    return;
  }
  
  String endpoint = isEmergency ? "/emergency" : "/data";
  String url = "http://" + HUB_IP + endpoint;
  HTTPClient http;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  
  JsonDocument doc;
  doc["nodeId"] = NODE_ID;
  
  // –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
  #ifdef USE_CJMCU8128
    if (!isnan(data.tempCJMCU)) doc["tempCJMCU"] = round(data.tempCJMCU * 10) / 10.0;
    if (!isnan(data.humCJMCU)) doc["humCJMCU"] = round(data.humCJMCU * 10) / 10.0;
    if (!isnan(data.pressureCJMCU)) doc["pressureCJMCU"] = round(data.pressureCJMCU * 10) / 10.0;
    if (!isnan(data.co2CJMCU)) doc["co2CJMCU"] = data.co2CJMCU;
    if (!isnan(data.tvocCJMCU)) doc["tvocCJMCU"] = data.tvocCJMCU;
  #endif
  
  // ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
  
  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  doc["tempAHT"] = round(data.tempAHT * 10) / 10.0;
  doc["humAHT"] = round(data.humAHT * 10) / 10.0;
  doc["tempBMP"] = round(data.tempBMP * 10) / 10.0;
  doc["pressBMP"] = round(data.pressBMP * 10) / 10.0;
  doc["chain1"] = data.chain1;
  doc["chain2"] = data.chain2;
  doc["chain3"] = data.chain3;
  doc["rssi"] = data.rssi;
  doc["heap"] = data.freeHeap;
  
  String jsonString;
  serializeJson(doc, jsonString);
  
  int httpCode = http.POST(jsonString);
  if (httpCode > 0) {
    Serial.print(isEmergency ? "üö® –ê–í–ê–†–ò–Ø: " : "üìä –î–ê–ù–ù–´–ï: ");
    Serial.print("–£–∑–µ–ª ");
    Serial.print(NODE_ID);
    Serial.print(" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ö–æ–¥: ");
    Serial.println(httpCode);
  } else {
    Serial.print("‚ùå –û—à–∏–±–∫–∞ HTTP: ");
    Serial.println(http.errorToString(httpCode));
  }
  
  http.end();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ—Ç —Ö–∞–±–∞
void processCommand(String command) {
  Serial.print("üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ");
  Serial.println(command);
  
  lastReceivedCommand = command;
  
  if (command == "LED_ON") {
    digitalWrite(LED_PIN, LOW);
    data.ledState = true;
    Serial.println("üí° LED –í–ö–õ–Æ–ß–Å–ù");
    sendAckToHub("ACK_ON");
    
  } else if (command == "LED_OFF") {
    digitalWrite(LED_PIN, HIGH);
    data.ledState = false;
    Serial.println("üí° LED –í–´–ö–õ–Æ–ß–ï–ù");
    sendAckToHub("ACK_OFF");
    
  } else if (command == "RELAY_1_ON") {
    #ifdef RELAY_1_PIN
      digitalWrite(RELAY_1_PIN, HIGH);
      data.relay1State = true;
      Serial.println("üîå –†–ï–õ–ï 1 –í–ö–õ–Æ–ß–ï–ù–û");
      sendAckToHub("ACK_RELAY1_ON");
    #endif
    
  } else if (command == "RELAY_1_OFF") {
    #ifdef RELAY_1_PIN
      digitalWrite(RELAY_1_PIN, LOW);
      data.relay1State = false;
      Serial.println("üîå –†–ï–õ–ï 1 –í–´–ö–õ–Æ–ß–ï–ù–û");
      sendAckToHub("ACK_RELAY1_OFF");
    #endif
    
  } else if (command == "RELAY_2_ON") {
    #ifdef RELAY_2_PIN
      digitalWrite(RELAY_2_PIN, HIGH);
      data.relay2State = true;
      Serial.println("üîå –†–ï–õ–ï 2 –í–ö–õ–Æ–ß–ï–ù–û");
      sendAckToHub("ACK_RELAY2_ON");
    #endif
    
  } else if (command == "RELAY_2_OFF") {
    #ifdef RELAY_2_PIN
      digitalWrite(RELAY_2_PIN, LOW);
      data.relay2State = false;
      Serial.println("üîå –†–ï–õ–ï 2 –í–´–ö–õ–Æ–ß–ï–ù–û");
      sendAckToHub("ACK_RELAY2_OFF");
    #endif
    
  } else if (command == "GET_STATUS") {
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Ö–∞–±—É
    sendAckToHub("STATUS_OK");
    
  } else {
    Serial.print("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: ");
    Serial.println(command);
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ö–∞–±—É
void sendAckToHub(const char* ackCommand) {
  if (!espNowInitialized) {
    Serial.println("‚ö†Ô∏è ESP-NOW –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    return;
  }
  
  strncpy(outgoingMessage.command, ackCommand, sizeof(outgoingMessage.command)-1);
  outgoingMessage.sender_id = NODE_ID;
  outgoingMessage.target_id = 0; // 0 = —Ö–∞–±
  
  esp_err_t result = esp_now_send(hubMacAddress, (uint8_t *) &outgoingMessage, sizeof(outgoingMessage));
  
  Serial.print("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ '");
  Serial.print(ackCommand);
  Serial.print("': ");
  Serial.println(result == ESP_OK ? "OK" : "ERROR");
}

// –ö–æ–ª–±—ç–∫ –ø—Ä–∏–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö ESP-NOW
void onEspNowDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len) {
  memcpy(&incomingMessage, incomingData, min(len, (int)sizeof(incomingMessage)));
  
  Serial.print("üì• –ö–æ–º–∞–Ω–¥–∞ –æ—Ç —Ö–∞–±–∞: ");
  Serial.print(incomingMessage.command);
  Serial.print(" (—Ü–µ–ª—å: ");
  Serial.print(incomingMessage.target_id);
  Serial.println(")");
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ —ç—Ç–æ–º—É —É–∑–ª—É
  if (incomingMessage.target_id == 0 || incomingMessage.target_id == NODE_ID) {
    processCommand(String(incomingMessage.command));
  } else {
    Serial.print("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ —É–∑–ª—É ");
    Serial.print(incomingMessage.target_id);
    Serial.println(", –∏–≥–Ω–æ—Ä–∏—Ä—É—é");
  }
}

// –ö–æ–ª–±—ç–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
void onEspNowDataSent(const wifi_tx_info_t *info, esp_now_send_status_t status) {
  if (status != ESP_NOW_SEND_SUCCESS) {
    Serial.println("‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ö–∞–±—É");
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
void checkForAlarms() {
  if (millis() - lastEmergencySend < EMERGENCY_COOLDOWN) return;
  
  bool alarmDetected = false;
  
  #ifdef USE_MQ4
    if (!isnan(data.mq4Value) && data.mq4Value > 20.0) alarmDetected = true;
  #endif
  
  #ifdef USE_MQ7
    if (!isnan(data.mq7Value) && data.mq7Value > 15.0) alarmDetected = true;
  #endif
  
  #ifdef USE_INDUCTIVE_SENSOR
    if (data.inductiveState == 1) alarmDetected = true;
  #endif
  
  #ifdef USE_WATER_SENSOR
    if (data.waterState == 1) alarmDetected = true;
  #endif
  
  static int lastChain1 = 0, lastChain2 = 0, lastChain3 = 0;
  if (data.chain1 != lastChain1 || data.chain2 != lastChain2 || data.chain3 != lastChain3) {
    alarmDetected = true;
    lastChain1 = data.chain1;
    lastChain2 = data.chain2;
    lastChain3 = data.chain3;
  }
  
  if (alarmDetected) {
    sendDataToHub(true);
    lastEmergencySend = millis();
  }
}

// ======================================================================
// –†–ê–ó–î–ï–õ 10: –û–°–ù–û–í–ù–û–ô SETUP –ò LOOP
// ======================================================================

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n=== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –£–ó–ï–õ ESP32-C3 v3.0 ===");
  Serial.print("ID —É–∑–ª–∞: ");
  Serial.println(NODE_ID);
  Serial.print("MAC —É–∑–ª–∞: ");
  Serial.println(WiFi.macAddress());
  
  // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–æ–≤
  setupSensors();
  
  // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ IP
  Serial.print("–ù–∞–∑–Ω–∞—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP: ");
  Serial.println(local_IP);
  
  if (!WiFi.config(local_IP, gateway, subnet)) {
    Serial.println("‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ IP, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...");
  }
  
  // 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Wi-Fi
  WiFi.begin(SSID, PASSWORD);
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ ");
  Serial.print(SSID);
  Serial.print("...");
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    wifiConnected = true;
    Serial.println("\n‚úÖ Wi-Fi –ü–û–î–ö–õ–Æ–ß–ï–ù!");
    Serial.print("–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π IP: ");
    Serial.println(WiFi.localIP());
    Serial.print("RSSI: ");
    Serial.println(WiFi.RSSI());
  } else {
    wifiConnected = false;
    Serial.println("\n‚ùå –ù–ï –£–î–ê–õ–û–°–¨ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Wi-Fi!");
    Serial.println("–†–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ ESP-NOW");
  }
  
  // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ESP-NOW (–í–°–ï–ì–î–ê, –¥–∞–∂–µ –µ—Å–ª–∏ Wi-Fi –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)
  setupESP_NOW();
  
  // 5. –í—ã–≤–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  Serial.println("\n=== –ê–ö–¢–ò–í–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===");
  Serial.print("Wi-Fi: ");
  Serial.println(wifiConnected ? "ON" : "OFF");
  Serial.print("ESP-NOW: ");
  Serial.println(espNowInitialized ? "ON" : "OFF");
  Serial.print("–ú–æ—â–Ω–æ—Å—Ç—å TX: ");
  Serial.println(WiFi.getTxPower());
  Serial.println("==============================\n");
}

void loop() {
  // 1. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤
  readAllSensors();
  
  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
  checkForAlarms();
  
  // 3. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ö–∞–± (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ Wi-Fi –ø–æ–¥–∫–ª—é—á–µ–Ω)
  if (wifiConnected && (millis() - lastDataSend > DATA_SEND_INTERVAL)) {
    sendDataToHub(false);
    lastDataSend = millis();
  }
  
  // 4. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (—Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥)
  static unsigned long lastDiagnostic = 0;
  if (millis() - lastDiagnostic > 30000) {
    lastDiagnostic = millis();
    
    Serial.print("[–°–¢–ê–¢–£–°] –£–∑–µ–ª ");
    Serial.print(NODE_ID);
    Serial.print(" | Wi-Fi: ");
    Serial.print(wifiConnected ? "ON" : "OFF");
    Serial.print(" | ESP-NOW: ");
    Serial.print(espNowInitialized ? "ON" : "OFF");
    Serial.print(" | RSSI: ");
    Serial.print(WiFi.RSSI());
    Serial.print(" | –ü–∞–º—è—Ç—å: ");
    Serial.print(ESP.getFreeHeap());
    Serial.print(" | –¶–µ–ø–∏: [");
    Serial.print(data.chain1);
    Serial.print(",");
    Serial.print(data.chain2);
    Serial.print(",");
    Serial.print(data.chain3);
    Serial.print("] | –ü–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: ");
    Serial.println(lastReceivedCommand);
  }
  
  delay(100);
}

// ======================================================================
// –ö–û–ù–ï–¶ –°–ö–ï–¢–ß–ê
// ======================================================================
