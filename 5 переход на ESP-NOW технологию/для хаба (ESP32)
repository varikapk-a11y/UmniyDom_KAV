#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <AsyncTCP.h>
#include <esp_now.h>
#include <ArduinoJson.h>

const char* AP_SSID = "ESP32-Hub-Test";
const char* AP_PASSWORD = "test12345678";
uint8_t nodeMacAddress[] = {0xAC, 0xEB, 0xE6, 0x49, 0x10, 0x28}; // MAC узла

typedef struct esp_now_message {
    char command[16]; // "LED_ON", "LED_OFF", "ACK_ON", "ACK_OFF"
    uint8_t sender_id;
} esp_now_message;

esp_now_message outgoingMessage;
esp_now_message incomingMessage;

AsyncWebServer server(80);
AsyncWebSocket ws("/ws");

void onWebSocketEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len);
void onEspNowDataSent(const esp_now_send_info_t *send_info, esp_now_send_status_t status);
void onEspNowDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len);
void sendCommandToNode(String cmd);
void broadcastStatus(String statusText);

void setup() {
    Serial.begin(115200);
    delay(1000);
    Serial.println("\n=== ESP-NOW HUB (PlatformIO) ===");

    WiFi.mode(WIFI_AP);
    if (!WiFi.softAP(AP_SSID, AP_PASSWORD)) {
        Serial.println("AP Failed");
        while(1);
    }
    Serial.print("AP IP: ");
    Serial.println(WiFi.softAPIP());

    server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) {
        String html = R"rawliteral(
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Тест ESP-NOW Хаб</title>
            <style>
                body {font-family: Arial; text-align: center; margin-top: 50px;}
                button {font-size: 20px; padding: 15px 30px; margin: 10px; border: none; border-radius: 8px; cursor: pointer;}
                #btnOn {background: #4CAF50; color: white;}
                #btnOff {background: #f44336; color: white;}
                #status {margin-top: 30px; font-size: 22px; padding: 15px; background: #f5f5f5; border-radius: 8px;}
                .on {color: #4CAF50; font-weight: bold;}
                .off {color: #f44336; font-weight: bold;}
            </style>
        </head>
        <body>
            <h1>ESP-NOW Тест: Управление удалённым узлом</h1>
            <p>MAC узла: AC:EB:E6:49:10:28</p>
            <button id="btnOn" onclick="sendCommand('LED_ON')">▶ ВКЛЮЧИТЬ LED</button>
            <button id="btnOff" onclick="sendCommand('LED_OFF')">⏸ ВЫКЛЮЧИТЬ LED</button>
            <div id="status">Статус: Ожидание подключения...</div>
            <script>
                const ws = new WebSocket('ws://' + window.location.hostname + '/ws');
                ws.onopen = function() {
                    document.getElementById('status').innerHTML = 'Статус: <span class="on">Подключён к хабу</span>';
                };
                ws.onmessage = function(event) {
                    const msg = JSON.parse(event.data);
                    if(msg.type === 'status') {
                        const statusElem = document.getElementById('status');
                        statusElem.innerHTML = 'Статус узла: <span class="' + msg.state + '">' + msg.text + '</span>';
                        if(msg.state === 'on') {
                            document.getElementById('btnOn').style.opacity = '0.6';
                            document.getElementById('btnOff').style.opacity = '1';
                        } else {
                            document.getElementById('btnOn').style.opacity = '1';
                            document.getElementById('btnOff').style.opacity = '0.6';
                        }
                    }
                };
                function sendCommand(cmd) {
                    ws.send(JSON.stringify({command: cmd}));
                }
            </script>
        </body>
        </html>
        )rawliteral";
        request->send(200, "text/html", html);
    });

    ws.onEvent(onWebSocketEvent);
    server.addHandler(&ws);
    server.begin();

    WiFi.mode(WIFI_AP_STA);
    if (esp_now_init() != ESP_OK) {
        Serial.println("ESP-NOW Init Failed");
        while(1);
    }
    esp_now_register_send_cb(onEspNowDataSent);
    esp_now_register_recv_cb(onEspNowDataRecv);

    esp_now_peer_info_t peerInfo = {};
    memcpy(peerInfo.peer_addr, nodeMacAddress, 6);
    peerInfo.channel = 0;
    peerInfo.encrypt = false;
    if (esp_now_add_peer(&peerInfo) != ESP_OK) {
        Serial.println("Failed to add peer");
    }
    Serial.println("Setup complete.");
}

void loop() { ws.cleanupClients(); delay(10); }

void onWebSocketEvent(AsyncWebSocket *server, AsyncWebSocketClient *client, AwsEventType type, void *arg, uint8_t *data, size_t len) {
    if (type == WS_EVT_DATA) {
        StaticJsonDocument<256> doc;
        DeserializationError error = deserializeJson(doc, data, len);
        if (!error && doc.containsKey("command")) {
            String cmd = doc["command"].as<String>();
            Serial.print("Web command: ");
            Serial.println(cmd);
            sendCommandToNode(cmd);
        }
    }
}

void sendCommandToNode(String cmd) {
    strncpy(outgoingMessage.command, cmd.c_str(), sizeof(outgoingMessage.command)-1);
    outgoingMessage.sender_id = 1;
    esp_err_t result = esp_now_send(nodeMacAddress, (uint8_t *) &outgoingMessage, sizeof(outgoingMessage));
    Serial.print("Send to node: ");
    Serial.println(result == ESP_OK ? "OK" : "ERROR");
}

void onEspNowDataSent(const esp_now_send_info_t *send_info, esp_now_send_status_t status) {
    Serial.print("Delivery to ");
    for (int i = 0; i < 6; i++) {
        Serial.print(send_info->target_addr[i], HEX);
        if (i < 5) Serial.print(":");
    }
    Serial.print(": ");
    Serial.println(status == ESP_NOW_SEND_SUCCESS ? "Success" : "Fail");
}

void onEspNowDataRecv(const esp_now_recv_info_t *recv_info, const uint8_t *incomingData, int len) {
    const uint8_t *senderMac = recv_info->src_addr;
    memcpy(&incomingMessage, incomingData, sizeof(incomingMessage));
    Serial.print("Received from ");
    for (int i = 0; i < 6; i++) {
        Serial.print(senderMac[i], HEX);
        if (i < 5) Serial.print(":");
    }
    Serial.print(": ");
    Serial.println(incomingMessage.command);

    if (strcmp(incomingMessage.command, "ACK_ON") == 0) {
        broadcastStatus("LED на узле ВКЛЮЧЁН");
    } else if (strcmp(incomingMessage.command, "ACK_OFF") == 0) {
        broadcastStatus("LED на узле ВЫКЛЮЧЕН");
    }
}

void broadcastStatus(String statusText) {
    StaticJsonDocument<256> doc;
    doc["type"] = "status";
    doc["text"] = statusText;
    doc["state"] = statusText.indexOf("ВКЛ") != -1 ? "on" : "off";
    String jsonResponse;
    serializeJson(doc, jsonResponse);
    ws.textAll(jsonResponse);
    Serial.print("Status updated: ");
    Serial.println(statusText);
}
