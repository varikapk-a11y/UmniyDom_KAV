/*
  ESP32-S3 SMART HOME HUB - –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
  –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–æ–¥
  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π WebServer + ESP-NOW
*/

// ========== –ë–ò–ë–õ–ò–û–¢–ï–ö–ò ==========
#include <WiFi.h>
#include <WebServer.h>
#include <esp_now.h>
#include <esp_wifi.h>

// ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
#define HUB_ID 1
#define HTTP_PORT 80
#define NODE_TIMEOUT 30000

const char* AP_SSID = "SmartHomeHub-S3";
const char* AP_PASSWORD = "12345678";  // 8+ —Å–∏–º–≤–æ–ª–æ–≤

// ========== –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–• ==========
#pragma pack(push, 1)
typedef struct {
  char command[32];
  uint8_t sender_id;
  uint8_t target_id;
  uint32_t timestamp;
} espnow_message_t;
#pragma pack(pop)

typedef struct {
  uint8_t id;
  bool online;
  String lastSeen;
  unsigned long lastUpdate;
} node_data_t;

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
WebServer server(HTTP_PORT);
node_data_t nodes[5];
uint8_t nodeCount = 0;
bool espnowActive = false;

// MAC-–∞–¥—Ä–µ—Å–∞ —É–∑–ª–æ–≤ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò!)
const uint8_t NODE_MACS[][6] = {
  {0x9C, 0x9C, 0x1F, 0xC7, 0x2D, 0x94},  // –£–∑–µ–ª 1
  {0x24, 0x6F, 0x28, 0x8A, 0x10, 0x3C}   // –£–∑–µ–ª 2
};
const uint8_t NODE_MACS_COUNT = sizeof(NODE_MACS) / 6;

// ========== –§–£–ù–ö–¶–ò–ò ESP-NOW ==========
void initESPNow() {
  if (esp_now_init() != ESP_OK) {
    Serial.println("‚ùå ESP-NOW init failed");
    return;
  }
  
  esp_now_register_recv_cb([](const esp_now_recv_info_t *info, const uint8_t *data, int len) {
    (void)info; // –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
    
    if (len < (int)sizeof(espnow_message_t)) return;
    
    espnow_message_t msg;
    memcpy(&msg, data, sizeof(msg));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —É–∑–µ–ª
    for (uint8_t i = 0; i < nodeCount; i++) {
      if (nodes[i].id == msg.sender_id) {
        nodes[i].online = true;
        nodes[i].lastUpdate = millis();
        nodes[i].lastSeen = getTimeString();
        
        Serial.printf("üì• –£–∑–µ–ª %d: %s\n", msg.sender_id, msg.command);
        return;
      }
    }
    
    // –ù–æ–≤—ã–π —É–∑–µ–ª
    if (nodeCount < 5) {
      nodes[nodeCount].id = msg.sender_id;
      nodes[nodeCount].online = true;
      nodes[nodeCount].lastUpdate = millis();
      nodes[nodeCount].lastSeen = getTimeString();
      nodeCount++;
      Serial.printf("üÜï –ù–æ–≤—ã–π —É–∑–µ–ª: #%d\n", msg.sender_id);
    }
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∏—Ä–æ–≤
  esp_now_peer_info_t peer = {};
  peer.channel = 1;
  peer.encrypt = false;
  
  for (uint8_t i = 0; i < NODE_MACS_COUNT; i++) {
    memcpy(peer.peer_addr, NODE_MACS[i], 6);
    esp_now_add_peer(&peer);
  }
  
  espnowActive = true;
  Serial.println("‚úÖ ESP-NOW ready");
}

bool sendESPNowCommand(uint8_t nodeId, const char* command) {
  if (!espnowActive || nodeId == 0 || nodeId > NODE_MACS_COUNT) {
    return false;
  }
  
  espnow_message_t msg;
  strlcpy(msg.command, command, sizeof(msg.command));
  msg.sender_id = HUB_ID;
  msg.target_id = nodeId;
  msg.timestamp = millis();
  
  esp_err_t result = esp_now_send(NODE_MACS[nodeId-1], (uint8_t*)&msg, sizeof(msg));
  
  Serial.printf("üì§ –£–∑–µ–ª %d: %s (%s)\n", 
                nodeId, command, 
                result == ESP_OK ? "OK" : "FAIL");
  return result == ESP_OK;
}

// ========== –í–ï–ë-–°–ï–†–í–ï–† ==========
void initWebServer() {
  // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
  server.on("/", HTTP_GET, []() {
    String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    html += "<title>–£–º–Ω—ã–π –î–æ–º –•–∞–±</title><style>";
    html += "body{font-family:Arial;padding:20px;background:#f5f5f5;}";
    html += ".container{background:white;padding:20px;border-radius:10px;max-width:800px;margin:0 auto;}";
    html += "h1{color:#4361ee;} .node{background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #4361ee;}";
    html += ".online{color:#2ecc71;} .offline{color:#e74c3c;}";
    html += "button{background:#4361ee;color:white;border:none;padding:10px 15px;margin:5px;border-radius:5px;cursor:pointer;}";
    html += "button:hover{background:#3a0ca3;} .status-bar{display:flex;gap:15px;margin:20px 0;}";
    html += ".status-item{background:#e9ecef;padding:10px;border-radius:5px;}";
    html += "</style></head><body><div class='container'>";
    
    html += "<h1>üè† –£–º–Ω—ã–π –î–æ–º –•–∞–± (ESP32-S3)</h1>";
    
    // –°—Ç–∞—Ç—É—Å-–±–∞—Ä
    html += "<div class='status-bar'>";
    html += "<div class='status-item'>Wi-Fi: " + String(AP_SSID) + "</div>";
    html += "<div class='status-item'>IP: " + WiFi.softAPIP().toString() + "</div>";
    html += "<div class='status-item'>–£–∑–ª–æ–≤: " + String(nodeCount) + "</div>";
    html += "</div>";
    
    // –°–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤
    html += "<h2>üì° –ê–∫—Ç–∏–≤–Ω—ã–µ —É–∑–ª—ã</h2>";
    if (nodeCount == 0) {
      html += "<p>–£–∑–ª—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã.</p>";
    } else {
      for (uint8_t i = 0; i < nodeCount; i++) {
        html += "<div class='node'>";
        html += "<strong>–£–∑–µ–ª #" + String(nodes[i].id) + "</strong> ";
        
        // –í–ê–ñ–ù–û: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º String() –¥–ª—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏
        html += "<span class='" + String(nodes[i].online ? "online" : "offline") + "'>";
        html += String(nodes[i].online ? "–û–ù–õ–ê–ô–ù" : "–û–§–§–õ–ê–ô–ù") + "</span><br>";
        
        html += "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç: " + nodes[i].lastSeen + "<br>";
        html += "<button onclick=\"sendCmd(" + String(nodes[i].id) + ", 'LED_ON')\">üí° –°–≤–µ—Ç –í–ö–õ</button>";
        html += "<button onclick=\"sendCmd(" + String(nodes[i].id) + ", 'LED_OFF')\">üí° –°–≤–µ—Ç –í–´–ö–õ</button>";
        html += "<button onclick=\"sendCmd(" + String(nodes[i].id) + ", 'GET_STATUS')\">üîÑ –°—Ç–∞—Ç—É—Å</button>";
        html += "</div>";
      }
    }
    
    // –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    html += "<h2>üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>";
    html += "<div style='margin:20px 0;'>";
    html += "<button onclick=\"sendCmd(1, 'LED_ON')\">–£–∑–µ–ª1 üí° –í–ö–õ</button>";
    html += "<button onclick=\"sendCmd(1, 'LED_OFF')\">–£–∑–µ–ª1 üí° –í–´–ö–õ</button>";
    html += "<button onclick=\"sendCmd(2, 'LED_ON')\">–£–∑–µ–ª2 üí° –í–ö–õ</button>";
    html += "<button onclick=\"sendCmd(2, 'LED_OFF')\">–£–∑–µ–ª2 üí° –í–´–ö–õ</button>";
    html += "<button onclick=\"location.reload()\">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>";
    html += "</div>";
    
    // JavaScript
    html += "<script>";
    html += "function sendCmd(nodeId, cmd) {";
    html += "  fetch('/cmd?node=' + nodeId + '&cmd=' + encodeURIComponent(cmd))";
    html += "    .then(r => r.text())";
    html += "    .then(t => console.log('–û—Ç–≤–µ—Ç:', t));";
    html += "  alert('–ö–æ–º–∞–Ω–¥–∞ \"' + cmd + '\" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É–∑–ª—É ' + nodeId);";
    html += "}";
    html += "</script>";
    
    html += "</div></body></html>";
    server.send(200, "text/html", html);
  });
  
  // API: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã
  server.on("/cmd", HTTP_GET, []() {
    if (server.hasArg("node") && server.hasArg("cmd")) {
      uint8_t nodeId = server.arg("node").toInt();
      String command = server.arg("cmd");
      
      bool success = sendESPNowCommand(nodeId, command.c_str());
      String response = success ? "OK" : "ERROR";
      
      server.send(200, "text/plain", "–ö–æ–º–∞–Ω–¥–∞ '" + command + "' –∫ —É–∑–ª—É " + String(nodeId) + ": " + response);
    } else {
      server.send(400, "text/plain", "–û—à–∏–±–∫–∞: –Ω—É–∂–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã node –∏ cmd");
    }
  });
  
  // API: —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤ (JSON)
  server.on("/api/nodes", HTTP_GET, []() {
    String json = "[";
    for (uint8_t i = 0; i < nodeCount; i++) {
      if (i > 0) json += ",";
      json += "{";
      json += "\"id\":" + String(nodes[i].id) + ",";
      json += "\"online\":" + String(nodes[i].online ? "true" : "false") + ",";
      json += "\"lastSeen\":\"" + nodes[i].lastSeen + "\"";
      json += "}";
    }
    json += "]";
    server.send(200, "application/json", json);
  });
  
  server.begin();
  Serial.println("‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 80");
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
String getTimeString() {
  unsigned long seconds = millis() / 1000;
  uint8_t hours = (uint8_t)((seconds / 3600) % 24);
  uint8_t minutes = (uint8_t)((seconds / 60) % 60);
  uint8_t secs = (uint8_t)(seconds % 60);
  
  char buf[10];
  snprintf(buf, sizeof(buf), "%02u:%02u:%02u", hours, minutes, secs);
  return String(buf);
}

void checkNodeTimeouts() {
  for (uint8_t i = 0; i < nodeCount; i++) {
    if (nodes[i].online && (millis() - nodes[i].lastUpdate > NODE_TIMEOUT)) {
      nodes[i].online = false;
      Serial.printf("‚è∞ –£–∑–µ–ª #%d: —Ç–∞–π–º–∞—É—Ç\n", nodes[i].id);
    }
  }
}

// ========== SETUP & LOOP ==========
void setup() {
  Serial.begin(115200);
  delay(3000); // –ñ–¥—ë–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Serial
  
  Serial.println("\n" + String(ESP.getChipModel()) + " SMART HOME HUB");
  Serial.println("========================================");
  
  // Wi-Fi —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞
  Serial.print("–ó–∞–ø—É—Å–∫ Wi-Fi: ");
  Serial.println(AP_SSID);
  
  WiFi.softAP(AP_SSID, AP_PASSWORD);
  delay(100);
  
  Serial.print("IP –∞–¥—Ä–µ—Å: ");
  Serial.println(WiFi.softAPIP());
  
  // ESP-NOW
  Serial.print("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ESP-NOW... ");
  initESPNow();
  
  // –í–µ–±-—Å–µ—Ä–≤–µ—Ä
  Serial.print("–ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞... ");
  initWebServer();
  
  Serial.println("\n‚úÖ –•–ê–ë –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï!");
  Serial.println("1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Wi-Fi: " + String(AP_SSID));
  Serial.println("2. –ü–∞—Ä–æ–ª—å: " + String(AP_PASSWORD));
  Serial.println("3. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://" + WiFi.softAPIP().toString());
  Serial.println("4. –ñ–¥–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É–∑–ª–æ–≤...\n");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞ –ø–ª–∞—Ç–µ)
  pinMode(48, OUTPUT);
  digitalWrite(48, HIGH); // –í–∫–ª—é—á–∞–µ–º –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
}

void loop() {
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±-–∑–∞–ø—Ä–æ—Å–æ–≤
  server.handleClient();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ —É–∑–ª–æ–≤
  static unsigned long lastCheck = 0;
  if (millis() - lastCheck > 5000) {
    lastCheck = millis();
    checkNodeTimeouts();
  }
  
  // –ú–∏–≥–∞–Ω–∏–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º (1 —Ä–∞–∑ –≤ 2 —Å–µ–∫)
  static unsigned long lastBlink = 0;
  if (millis() - lastBlink > 2000) {
    lastBlink = millis();
    digitalWrite(48, !digitalRead(48));
  }
  
  delay(10);
}
